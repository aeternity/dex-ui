<template>
  <div class="import-pool">
    <MainWrapper
      title="Import V2 Pool"
      back-button
    >
      <Tip tip="Use this tool to find v2 pools that don't automatically appear in the interface." />
      <ButtonToken
        fill="transparent"
        :token="tokenA"
        :include-wae="false"
        arrow
        @update:token="setSelectedToken($event, true)"
      />
      <PlusIcon />
      <ButtonToken
        fill="transparent"
        :token="tokenB"
        :include-wae="false"
        arrow
        @update:token="setSelectedToken($event, false)"
      />
      <div
        v-if="imported"
        class="pool-found"
      >
        Pool found!
      </div>
      <div class="connect">
        <div v-if="imported">
          <LiquidityDetails
            :pool-id="poolId"
            :pool-info="providedLiquidity[poolId]"
            :pool-info-importing="poolInfoImporting"
          />
        </div>
        <div
          v-if="!imported"
          class="footer-text"
        >
          {{ footerText }}
        </div>
      </div>
    </MainWrapper>
  </div>
</template>

<script>
import { mapState } from 'vuex';
import MainWrapper from '@/components/MainWrapper.vue';
import ButtonToken from '@/components/ButtonToken.vue';
import Tip from '@/components/Tip.vue';
import { calculateSelectedToken } from '../lib/utils';
import { getPairId } from '../store/modules/aeternity';
import LiquidityDetails from '../components/LiquidityDetails.vue';
import PlusIcon from '../assets/plus.svg?vue-component';

export default {
  components: {
    MainWrapper,
    ButtonToken,
    Tip,
    LiquidityDetails,
    PlusIcon,
  },
  data: () => ({
    tokenA: null,
    tokenB: null,
    imported: false,
    importing: false,
    poolInfoImporting: false,
  }),
  computed: {
    poolId() {
      if (!this.tokenA || !this.tokenB) {
        return null;
      }
      return getPairId(this.tokenA.contract_id, this.tokenB.contract_id);
    },
    ...mapState(['address']),
    ...mapState('aeternity', ['providedLiquidity']),
    footerText() {
      if (this.importing) return 'Fetching data...';
      if (!this.address) return 'Connect to a wallet to find pools';
      if (!this.tokenA || !this.tokenB) return 'Select both tokens to find your provided liquidity.';
      if (this.imported) return 'The liquidity is imported, you can go back to see your provided liquidity in the main pool screen';
      return 'You have no provided liquidity for the selected tokens';
    },
  },
  methods: {
    async setSelectedToken(token, isFrom) {
      [this.tokenA, this.tokenB] = calculateSelectedToken(token, this.tokenA, this.tokenB, isFrom);
      if (this.tokenA && this.tokenB) {
        // to refresh liquidity list
        try {
          this.importing = true;
          const balance = await this.$store.dispatch('aeternity/pullAccountLiquidity', {
            tokenA: this.tokenA.contract_id,
            tokenB: this.tokenB.contract_id,
            tokenASymbol: this.tokenA.symbol,
            tokenBSymbol: this.tokenB.symbol,
            tokenADecimals: this.tokenA.decimals,
            tokenBDecimals: this.tokenB.decimals,
          });
          if (balance) {
            this.imported = true;
            this.poolInfoImporting = true;
            await this.$store.dispatch('aeternity/getPoolInfo', {
              tokenA: this.tokenA.contract_id,
              tokenB: this.tokenB.contract_id,
            });
            this.poolInfoImporting = false;
            return;
          }
        } catch (e) {
          if (e.message === 'PAIR NOT FOUND') return;
          await this.$store.dispatch('showUnknownError', e);
        } finally {
          this.importing = false;
        }
      }
      this.imported = false;
    },
  },
};
</script>

<style lang="scss" scoped>
@use '../styles/variables.scss';
@use '../styles/typography.scss';

.import-pool {
  .button-token {
    margin: 12px 0;
  }

  .pool-found {
    margin-bottom: 12px;
    color: variables.$color-white;
  }

  .connect {
    color: variables.$color-white;
    width: 100%;
    padding: 10px 15px;
    border-radius: 16px;
    border: 1px solid variables.$color-black;
    background-color: variables.$color-black2;

    p {
      margin: 0;
    }

    .footer-text {
      width: 100%;
      padding: 35px 0;
    }

    .manage-btn {
      color: variables.$color-blue;

      @extend %face-sans-16-regular;

      &:hover {
        color: variables.$color-blue-hover;
      }
    }

    .pool-info {
      border: 1px solid variables.$color-black;
      background-color: variables.$color-black2;
      border-radius: 20px;
      padding: 16px;
      text-align: left;

      img {
        width: 20px;
        height: 20px;
      }

      .balance {
        display: flex;
        align-items: center;
        font-size: 20px;

        img:nth-of-type(1) {
          margin-left: 4px;
          z-index: 1;
        }

        img:nth-of-type(2) {
          margin-left: -10px;
        }
      }
    }
  }

  .price {
    display: flex;
    color: white;
    justify-content: flex-end;
    margin-top: 8px;

    @extend %face-sans-14-medium;
  }
}
</style>
